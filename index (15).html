<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DGclinR - Clinical Trials Database with ARM & References</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(107, 114, 128, 0.5);
      border-radius: 3px;
    }
    /* Simple contenteditable styling */
    .editable-table {
      border: 1px solid #cbd5e1;
      border-radius: 0.375rem;
      padding: 0.5rem;
      min-height: 100px;
      overflow: auto;
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Login Overlay -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
      <h2 class="text-2xl font-semibold mb-6 text-center text-blue-900">Login to DGclinR</h2>
      <form id="loginForm" class="space-y-4" autocomplete="off" novalidate>
        <div>
          <label for="username" class="block font-medium mb-1">Username</label>
          <input type="text" id="username" name="username" required autocomplete="username" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
        </div>
        <div>
          <label for="password" class="block font-medium mb-1">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
        </div>
        <div id="loginMessage" class="text-sm text-red-600 min-h-[1.25rem]"></div>
        <button type="submit" class="w-full bg-blue-900 text-white font-semibold rounded px-4 py-2 hover:bg-blue-800 transition">
          <i class="fas fa-sign-in-alt mr-2"></i> Login
        </button>
      </form>
    </div>
  </div>

  <div id="appContent" class="hidden flex flex-col min-h-screen">
    <header class="bg-blue-900 text-white shadow">
      <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center md:justify-between">
        <h1 class="text-2xl font-semibold flex items-center gap-2">
          <i class="fas fa-database"></i> DGclinR
        </h1>
        <nav class="mt-3 md:mt-0">
          <ul class="flex flex-wrap gap-4 text-sm md:text-base">
            <li><a href="#search" class="hover:underline">Search Trials</a></li>
            <li><a href="#add-trial" class="hover:underline">Add Trial</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex-grow">
      <!-- Trial Search Section -->
      <section id="search" class="mb-12">
        <h2 class="text-3xl font-semibold mb-4 text-blue-900 flex items-center gap-3">
          <i class="fas fa-search"></i> Search Clinical Trials
        </h2>
        <form id="trialSearchForm" class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-4 gap-6">
          <div>
            <label for="searchTrialId" class="block font-medium mb-1">Trial ID</label>
            <input type="text" id="searchTrialId" name="trial_id" placeholder="e.g. 1" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="searchOtherStudyId" class="block font-medium mb-1">Other Study ID</label>
            <input type="text" id="searchOtherStudyId" name="other_study_id" placeholder="Other Study ID" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="searchTitle" class="block font-medium mb-1">Title</label>
            <input type="text" id="searchTitle" name="title" placeholder="Trial title keywords" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="searchIndication" class="block font-medium mb-1">Indication</label>
            <input type="text" id="searchIndication" name="indication" placeholder="Disease or condition" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="searchPhase" class="block font-medium mb-1">Phase</label>
            <select id="searchPhase" name="phase" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Any</option>
              <option value="Phase 1">Phase 1</option>
              <option value="Phase 2">Phase 2</option>
              <option value="Phase 3">Phase 3</option>
              <option value="Phase 4">Phase 4</option>
            </select>
          </div>
          <div>
            <label for="searchStatus" class="block font-medium mb-1">Status</label>
            <select id="searchStatus" name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Any</option>
              <option value="Recruiting">Recruiting</option>
              <option value="Active">Active</option>
              <option value="Completed">Completed</option>
              <option value="Terminated">Terminated</option>
              <option value="Suspended">Suspended</option>
            </select>
          </div>
          <div class="flex items-end">
            <button type="submit" class="w-full bg-blue-900 text-white font-semibold rounded px-4 py-2 hover:bg-blue-800 transition">
              <i class="fas fa-search mr-2"></i> Search
            </button>
          </div>
        </form>
        <div id="searchResults" class="mt-8 bg-white rounded-lg shadow p-6 min-h-[150px]">
          <p class="text-gray-600 italic">No search performed yet.</p>
        </div>
      </section>

      <!-- Add Trial Section -->
      <section id="add-trial" class="mb-12">
        <h2 class="text-3xl font-semibold mb-4 text-blue-900 flex items-center gap-3">
          <i class="fas fa-plus-circle"></i> Add New Clinical Trial
        </h2>
        <form id="addTrialForm" class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl">
          <div>
            <label for="trialId" class="block font-medium mb-1">Trial ID *</label>
            <input type="number" id="trialId" name="trial_id" required placeholder="Unique Trial ID" min="1" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialTitle" class="block font-medium mb-1">Title *</label>
            <input type="text" id="trialTitle" name="title" required placeholder="Trial title" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialOtherStudyId" class="block font-medium mb-1">Other Study ID</label>
            <input type="text" id="trialOtherStudyId" name="other_study_id" placeholder="Other Study ID" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialIndication" class="block font-medium mb-1">Indication</label>
            <input type="text" id="trialIndication" name="indication" placeholder="Disease or condition" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialEnrollment" class="block font-medium mb-1">Enrollment</label>
            <input type="number" id="trialEnrollment" name="enrollment" min="0" placeholder="Number of participants" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialPhase" class="block font-medium mb-1">Phase</label>
            <select id="trialPhase" name="phase" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select phase</option>
              <option value="Phase 1">Phase 1</option>
              <option value="Phase 2">Phase 2</option>
              <option value="Phase 3">Phase 3</option>
              <option value="Phase 4">Phase 4</option>
            </select>
          </div>
          <div>
            <label for="trialStudyType" class="block font-medium mb-1">Study Type</label>
            <select id="trialStudyType" name="study_type" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select study type</option>
              <option value="Interventional">Interventional</option>
              <option value="Observational">Observational</option>
              <option value="Expanded Access">Expanded Access</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="trialStatus" class="block font-medium mb-1">Status</label>
            <select id="trialStatus" name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select status</option>
              <option value="Recruiting">Recruiting</option>
              <option value="Active">Active</option>
              <option value="Completed">Completed</option>
              <option value="Terminated">Terminated</option>
              <option value="Suspended">Suspended</option>
            </select>
          </div>
          <div>
            <label for="trialSponsor" class="block font-medium mb-1">Sponsor</label>
            <input type="text" id="trialSponsor" name="sponsor" placeholder="Sponsor company name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialProductTags" class="block font-medium mb-1">Product Tags</label>
            <select id="trialProductTags" name="product_tags" multiple size="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
            </select>
            <p class="text-xs text-gray-500 mt-1">Hold Ctrl (Cmd on Mac) to select multiple products.</p>
          </div>
          <div>
            <label for="trialAllocation" class="block font-medium mb-1">Allocation</label>
            <select id="trialAllocation" name="allocation" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select allocation</option>
              <option value="Randomized">Randomized</option>
              <option value="Non-Randomized">Non-Randomized</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="trialStartDate" class="block font-medium mb-1">Start Date</label>
            <input type="date" id="trialStartDate" name="start_date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialEndDate" class="block font-medium mb-1">End Date</label>
            <input type="date" id="trialEndDate" name="end_date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="reset" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
              Reset
            </button>
            <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Add Trial
            </button>
          </div>
        </form>
        <div id="addTrialMessage" class="mt-4 text-sm"></div>
      </section>

      <!-- Trial Details & Tabs Section (hidden initially) -->
      <section id="trialDetailsSection" class="hidden bg-white rounded-lg shadow-md p-6 max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 id="trialDetailsTitle" class="text-3xl font-semibold text-blue-900 flex items-center gap-3">
            <i class="fas fa-vials"></i> Trial Details
          </h2>
          <button id="closeTrialDetailsBtn" aria-label="Close trial details" class="text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
        </div>

        <div id="trialSummary" class="mb-6 border border-gray-300 rounded p-4 bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-700">
        </div>

        <nav class="mb-6 border-b border-gray-300">
          <ul id="tabs" class="flex flex-wrap gap-2 text-sm font-semibold text-gray-600">
            <li><button data-tab="products" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 bg-gray-200 text-blue-900">Products (ARM-wise)</button></li>
            <li><button data-tab="patients" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 hover:bg-gray-100">Patients (ARM-wise)</button></li>
            <li><button data-tab="adverseEvents" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 hover:bg-gray-100">Adverse Events (ARM-wise)</button></li>
            <li><button data-tab="responseData" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 hover:bg-gray-100">Response Data</button></li>
            <li><button data-tab="survivalData" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 hover:bg-gray-100">Survival Data</button></li>
            <li><button data-tab="regulatoryEvents" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 hover:bg-gray-100">Regulatory Announcements</button></li>
            <li><button data-tab="references" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-300 hover:bg-gray-100">All References</button></li>
          </ul>
        </nav>

        <div id="tabContent" class="min-h-[400px]"></div>
      </section>
    </main>

    <footer class="bg-blue-900 text-white py-4 text-center text-sm">
      DGclinR &copy; 2024 Clinical Trials Database
    </footer>
  </div>

  <script>
    // In-memory data storage simulation
    const trials = [];
    const products = [];
    const patients = [];
    const adverseEvents = [];
    const responseData = [];
    const survivalData = [];
    const regulatoryEvents = [];
    const references = []; // unified references for all tabs
    const trial_products = [];

    // Login credentials
    const validUsername = 'Dilip';
    const validPassword = 'Dilip@321';

    // Show login overlay initially
    const loginOverlay = document.getElementById('loginOverlay');
    const appContent = document.getElementById('appContent');
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');

    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const username = loginForm.username.value.trim();
      const password = loginForm.password.value;

      if (username === validUsername && password === validPassword) {
        loginOverlay.classList.add('hidden');
        appContent.classList.remove('hidden');
        loginForm.reset();
        loginMessage.textContent = '';
      } else {
        loginMessage.textContent = 'Invalid username or password.';
      }
    });

    function generateId(collection) {
      return collection.length ? collection[collection.length - 1].id + 1 : 1;
    }

    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = isError ? 'mt-4 text-sm text-red-600' : 'mt-4 text-sm text-green-600';
      setTimeout(() => {
        el.textContent = '';
      }, 5000);
    }

    // Populate product tags select on page load and when products change
    function populateProductTags() {
      const select = document.getElementById('trialProductTags');
      if (!select) return;
      select.innerHTML = '';
      products.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.textContent = p.name;
        select.appendChild(option);
      });
    }

    // Add Trial Form Submission
    document.getElementById('addTrialForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const trial_id_raw = formData.get('trial_id');
      const trial_id = trial_id_raw ? parseInt(trial_id_raw) : null;
      if (!trial_id || trial_id < 1) {
        showMessage('addTrialMessage', 'Trial ID is required and must be a positive number.', true);
        return;
      }
      // Check for duplicate trial_id
      if (trials.some(t => t.id === trial_id)) {
        showMessage('addTrialMessage', `Trial ID ${trial_id} already exists. Please use a unique Trial ID.`, true);
        return;
      }
      const title = formData.get('title').trim();
      const other_study_id = formData.get('other_study_id').trim() || null;
      const indication = formData.get('indication').trim();
      const enrollmentRaw = formData.get('enrollment');
      const enrollment = enrollmentRaw ? parseInt(enrollmentRaw) : null;
      const phase = formData.get('phase');
      const study_type = formData.get('study_type') || null;
      const status = formData.get('status');
      const sponsor = formData.get('sponsor').trim() || null;
      const product_tags_raw = formData.getAll('product_tags');
      const product_tags = product_tags_raw.length ? product_tags_raw : [];
      const allocation = formData.get('allocation') || null;
      const start_date = formData.get('start_date') || null;
      const end_date = formData.get('end_date') || null;

      const newTrial = {
        id: trial_id,
        title,
        other_study_id,
        indication: indication || null,
        enrollment,
        phase: phase || null,
        study_type,
        status: status || null,
        sponsor,
        product_tags,
        allocation,
        start_date,
        end_date,
        created_at: new Date().toISOString()
      };
      trials.push(newTrial);
      this.reset();
      showMessage('addTrialMessage', `Trial ID ${newTrial.id} added successfully.`);

      loadTrialDetails(newTrial.id);
      document.getElementById('trialDetailsSection').scrollIntoView({ behavior: 'smooth' });
    });

    // Search Trials
    document.getElementById('trialSearchForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const trialId = formData.get('trial_id').trim();
      const otherStudyId = formData.get('other_study_id').trim().toLowerCase();
      const title = formData.get('title').trim().toLowerCase();
      const indication = formData.get('indication').trim().toLowerCase();
      const phase = formData.get('phase');
      const status = formData.get('status');

      let results = trials.filter(trial => {
        return (
          (trialId === '' || trial.id.toString() === trialId) &&
          (otherStudyId === '' || (trial.other_study_id && trial.other_study_id.toLowerCase() === otherStudyId)) &&
          (title === '' || trial.title.toLowerCase().includes(title)) &&
          (indication === '' || (trial.indication && trial.indication.toLowerCase().includes(indication))) &&
          (phase === '' || trial.phase === phase) &&
          (status === '' || trial.status === status)
        );
      });

      const resultsContainer = document.getElementById('searchResults');
      if (results.length === 0) {
        resultsContainer.innerHTML = '<p class="text-gray-600 italic">No trials found matching the criteria.</p>';
        return;
      }

      let html = `<div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 rounded-md">
          <thead class="bg-blue-900 text-white">
            <tr>
              <th class="px-4 py-2 text-left">Trial ID</th>
              <th class="px-4 py-2 text-left">Other Study ID</th>
              <th class="px-4 py-2 text-left">Title</th>
              <th class="px-4 py-2 text-left">Indication</th>
              <th class="px-4 py-2 text-left">Enrollment</th>
              <th class="px-4 py-2 text-left">Phase</th>
              <th class="px-4 py-2 text-left">Study Type</th>
              <th class="px-4 py-2 text-left">Status</th>
              <th class="px-4 py-2 text-left">Sponsor</th>
              <th class="px-4 py-2 text-left">Product Tags</th>
              <th class="px-4 py-2 text-left">Allocation</th>
              <th class="px-4 py-2 text-left">Start Date</th>
              <th class="px-4 py-2 text-left">End Date</th>
              <th class="px-4 py-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>`;

      for (const trial of results) {
        html += `<tr class="border-t border-gray-200 hover:bg-gray-100" tabindex="0" aria-label="View or edit trial ${trial.id}">
          <td class="px-4 py-2">${trial.id}</td>
          <td class="px-4 py-2">${trial.other_study_id || ''}</td>
          <td class="px-4 py-2">${trial.title}</td>
          <td class="px-4 py-2">${trial.indication || ''}</td>
          <td class="px-4 py-2">${trial.enrollment !== null && trial.enrollment !== undefined ? trial.enrollment : ''}</td>
          <td class="px-4 py-2">${trial.phase || ''}</td>
          <td class="px-4 py-2">${trial.study_type || ''}</td>
          <td class="px-4 py-2">${trial.status || ''}</td>
          <td class="px-4 py-2">${trial.sponsor || ''}</td>
          <td class="px-4 py-2">${trial.product_tags && trial.product_tags.length ? trial.product_tags.join(', ') : ''}</td>
          <td class="px-4 py-2">${trial.allocation || ''}</td>
          <td class="px-4 py-2">${trial.start_date || ''}</td>
          <td class="px-4 py-2">${trial.end_date || ''}</td>
          <td class="px-4 py-2">
            <button data-trial-id="${trial.id}" class="view-edit-btn bg-blue-700 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm">
              <i class="fas fa-edit"></i> Edit
            </button>
          </td>
        </tr>`;
      }

      html += `</tbody></table></div>`;

      resultsContainer.innerHTML = html;

      const editButtons = resultsContainer.querySelectorAll('.view-edit-btn');
      editButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const trialId = parseInt(btn.getAttribute('data-trial-id'));
          loadTrialDetails(trialId);
          document.getElementById('trialDetailsSection').scrollIntoView({ behavior: 'smooth' });
        });
      });
    });

    let currentTrialId = null;

    function loadTrialDetails(trialId) {
      const trial = trials.find(t => t.id === trialId);
      if (!trial) return;

      const detailsSection = document.getElementById('trialDetailsSection');
      detailsSection.classList.remove('hidden');

      const summary = `
        <div><strong>Trial ID:</strong> ${trial.id}</div>
        <div><strong>Other Study ID:</strong> ${trial.other_study_id || 'N/A'}</div>
        <div><strong>Title:</strong> ${trial.title}</div>
        <div><strong>Indication:</strong> ${trial.indication || 'N/A'}</div>
        <div><strong>Enrollment:</strong> ${trial.enrollment !== null && trial.enrollment !== undefined ? trial.enrollment : 'N/A'}</div>
        <div><strong>Phase:</strong> ${trial.phase || 'N/A'}</div>
        <div><strong>Study Type:</strong> ${trial.study_type || 'N/A'}</div>
        <div><strong>Status:</strong> ${trial.status || 'N/A'}</div>
        <div><strong>Sponsor:</strong> ${trial.sponsor || 'N/A'}</div>
        <div><strong>Product Tags:</strong> ${trial.product_tags && trial.product_tags.length ? trial.product_tags.join(', ') : 'N/A'}</div>
        <div><strong>Allocation:</strong> ${trial.allocation || 'N/A'}</div>
        <div><strong>Start Date:</strong> ${trial.start_date || 'N/A'}</div>
        <div><strong>End Date:</strong> ${trial.end_date || 'N/A'}</div>
        <div><strong>Created At:</strong> ${new Date(trial.created_at).toLocaleString()}</div>
      `;
      document.getElementById('trialSummary').innerHTML = summary;

      currentTrialId = trialId;

      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.classList.remove('bg-gray-200', 'text-blue-900');
        btn.classList.add('hover:bg-gray-100');
      });
      tabButtons[0].classList.add('bg-gray-200', 'text-blue-900');
      loadTabContent('products');

      resetAllTabForms();
    }

    document.getElementById('closeTrialDetailsBtn').addEventListener('click', () => {
      document.getElementById('trialDetailsSection').classList.add('hidden');
      currentTrialId = null;
    });

    document.getElementById('tabs').addEventListener('click', e => {
      if (!e.target.classList.contains('tab-btn')) return;
      const tab = e.target.getAttribute('data-tab');
      if (!tab) return;

      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.classList.remove('bg-gray-200', 'text-blue-900');
        btn.classList.add('hover:bg-gray-100');
      });
      e.target.classList.add('bg-gray-200', 'text-blue-900');

      loadTabContent(tab);
    });

    function resetAllTabForms() {
      const forms = document.querySelectorAll('#tabContent form');
      forms.forEach(f => f.reset());
    }

    // === ARM management ===
    // For simplicity, arms are stored as array of strings per trial
    // We'll allow user to add arms in product tab and reuse in other tabs

    // Store arms per trial: { trialId: [armName1, armName2, ...] }
    const trialArms = {};

    // Get arms for current trial or empty array
    function getArms(trialId) {
      if (!trialArms[trialId]) trialArms[trialId] = [];
      return trialArms[trialId];
    }

    // Add arm if not exists
    function addArm(trialId, armName) {
      if (!trialArms[trialId]) trialArms[trialId] = [];
      if (!trialArms[trialId].includes(armName)) trialArms[trialId].push(armName);
    }

    // === References management ===
    // references: { id, trial_id, tab, source_name, link }
    // We'll add references from all tabs here and show in References tab

    // Add reference helper
    function addReference(trialId, tab, source_name, link) {
      if (!source_name || !link) return;
      // Check duplicate
      if (references.some(r => r.trial_id === trialId && r.tab === tab && r.source_name === source_name && r.link === link)) return;
      references.push({
        id: generateId(references),
        trial_id: trialId,
        tab,
        source_name,
        link
      });
    }

    // Load tab content dispatcher
    function loadTabContent(tab) {
      if (!currentTrialId) return;
      const container = document.getElementById('tabContent');
      container.innerHTML = '';

      switch (tab) {
        case 'products': renderProductsTab(container, currentTrialId); break;
        case 'patients': renderPatientsTab(container, currentTrialId); break;
        case 'adverseEvents': renderAdverseEventsTab(container, currentTrialId); break;
        case 'responseData': renderResponseDataTab(container, currentTrialId); break;
        case 'survivalData': renderSurvivalDataTab(container, currentTrialId); break;
        case 'regulatoryEvents': renderRegulatoryEventsTab(container, currentTrialId); break;
        case 'references': renderReferencesTab(container, currentTrialId); break;
        default: container.innerHTML = `<p class="text-gray-600 italic">Tab "${tab}" content not implemented.</p>`;
      }
    }

    // === PRODUCTS TAB ===
    // ARM wise product addition with dose and dosage details
    function renderProductsTab(container, trialId) {
      const arms = getArms(trialId);
      // Products linked to trial with arm info
      const trialProds = trial_products.filter(tp => tp.trial_id === trialId);

      let html = `
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h3 class="text-xl font-semibold text-blue-900">Products (ARM-wise)</h3>
          <button id="showAddProductFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
            <i class="fas fa-plus"></i> Add Product
          </button>
        </div>
      `;

      if (trialProds.length === 0) {
        html += `<p class="text-gray-600 italic mb-4">No products added yet.</p>`;
      } else {
        html += `<div class="overflow-x-auto max-h-64 scrollbar-thin border border-gray-300 rounded">
          <table class="min-w-full border-collapse border border-gray-300 text-sm">
            <thead class="bg-blue-900 text-white">
              <tr>
                <th class="px-3 py-2 text-left">ARM</th>
                <th class="px-3 py-2 text-left">Product Name</th>
                <th class="px-3 py-2 text-left">Dose</th>
                <th class="px-3 py-2 text-left">Dosage Details</th>
                <th class="px-3 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${trialProds.map(tp => {
                const prod = products.find(p => p.id === tp.product_id);
                return `<tr class="border-t border-gray-200 hover:bg-gray-100">
                  <td class="px-3 py-1">${tp.arm}</td>
                  <td class="px-3 py-1">${prod ? prod.name : ''}</td>
                  <td class="px-3 py-1">${tp.dose || ''}</td>
                  <td class="px-3 py-1">${tp.dosage_details || ''}</td>
                  <td class="px-3 py-1">
                    <button data-tp-id="${tp.id}" class="edit-product-btn text-blue-700 hover:underline text-sm">Edit</button>
                    <button data-tp-id="${tp.id}" class="remove-product-btn text-red-600 hover:underline text-sm ml-2">Remove</button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
      }

      // Add Product Form (hidden initially)
      html += `
        <form id="addProductForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-4xl hidden grid grid-cols-1 md:grid-cols-2 gap-4" novalidate>
          <h4 class="md:col-span-2 text-lg font-semibold text-blue-900">Add / Edit Product (ARM-wise)</h4>
          <input type="hidden" id="productEditId" name="product_edit_id" value="" />
          <div>
            <label for="productArm" class="block font-medium mb-1">ARM *</label>
            <input type="text" id="productArm" name="arm" placeholder="e.g. ARM 1" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" list="armsList" required />
            <datalist id="armsList">${arms.map(a => `<option value="${a}"></option>`).join('')}</datalist>
          </div>
          <div>
            <label for="productName" class="block font-medium mb-1">Product Name *</label>
            <input type="text" id="productName" name="name" placeholder="Product name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label for="productDose" class="block font-medium mb-1">Dose</label>
            <input type="text" id="productDose" name="dose" placeholder="Dose" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="productDosageDetails" class="block font-medium mb-1">Dosage Details</label>
            <textarea id="productDosageDetails" name="dosage_details" rows="3" placeholder="Dosage details" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600 resize-y"></textarea>
          </div>
          <div class="md:col-span-2">
            <label for="productSourceName" class="block font-medium mb-1">Reference Source Name</label>
            <input type="text" id="productSourceName" name="source_name" placeholder="Source name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2">
            <label for="productReferenceLink" class="block font-medium mb-1">Reference Link</label>
            <input type="url" id="productReferenceLink" name="reference_link" placeholder="https://example.com" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="button" id="cancelProductBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
            <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Save Product
            </button>
          </div>
          <div id="productFormMessage" class="md:col-span-2 text-sm mt-2"></div>
        </form>
      `;

      container.innerHTML = html;

      // Event handlers
      document.getElementById('showAddProductFormBtn').addEventListener('click', () => {
        resetProductForm();
        document.getElementById('addProductForm').classList.remove('hidden');
        document.getElementById('productArm').focus();
      });

      document.getElementById('cancelProductBtn').addEventListener('click', () => {
        resetProductForm();
        document.getElementById('addProductForm').classList.add('hidden');
      });

      document.getElementById('addProductForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const editId = form.product_edit_id.value;
        const arm = form.arm.value.trim();
        const name = form.name.value.trim();
        if (!arm || !name) {
          showProductFormMessage('ARM and Product Name are required.', true);
          return;
        }
        const dose = form.dose.value.trim() || null;
        const dosage_details = form.dosage_details.value.trim() || null;
        const source_name = form.source_name.value.trim() || null;
        const reference_link = form.reference_link.value.trim() || null;

        // Add arm if new
        addArm(currentTrialId, arm);

        // Check if product exists by name (case insensitive)
        let prod = products.find(p => p.name.toLowerCase() === name.toLowerCase());
        if (!prod) {
          prod = {
            id: generateId(products),
            name,
            moa: null,
            target: null,
            description: null
          };
          products.push(prod);
          populateProductTags();
        }

        if (editId) {
          // Edit existing trial_product entry
          const tpId = parseInt(editId);
          const tpIndex = trial_products.findIndex(tp => tp.id === tpId);
          if (tpIndex === -1) {
            showProductFormMessage('Product entry not found.', true);
            return;
          }
          trial_products[tpIndex].arm = arm;
          trial_products[tpIndex].product_id = prod.id;
          trial_products[tpIndex].dose = dose;
          trial_products[tpIndex].dosage_details = dosage_details;
          showProductFormMessage('Product updated successfully.');
        } else {
          // Add new trial_product entry
          trial_products.push({
            id: generateId(trial_products),
            trial_id: currentTrialId,
            arm,
            product_id: prod.id,
            dose,
            dosage_details
          });
          showProductFormMessage('Product added successfully.');
        }

        // Add reference if provided
        if (source_name && reference_link) {
          addReference(currentTrialId, 'products', source_name, reference_link);
        }

        loadTabContent('products');
      });

      container.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tpId = parseInt(btn.getAttribute('data-tp-id'));
          const tp = trial_products.find(t => t.id === tpId);
          if (!tp) return;
          const prod = products.find(p => p.id === tp.product_id);
          const form = document.getElementById('addProductForm');
          form.product_edit_id.value = tp.id;
          form.arm.value = tp.arm;
          form.name.value = prod ? prod.name : '';
          form.dose.value = tp.dose || '';
          form.dosage_details.value = tp.dosage_details || '';
          form.source_name.value = '';
          form.reference_link.value = '';
          document.getElementById('addProductForm').classList.remove('hidden');
          form.arm.focus();
        });
      });

      container.querySelectorAll('.remove-product-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tpId = parseInt(btn.getAttribute('data-tp-id'));
          const idx = trial_products.findIndex(tp => tp.id === tpId);
          if (idx !== -1) trial_products.splice(idx, 1);
          loadTabContent('products');
        });
      });

      function resetProductForm() {
        const form = document.getElementById('addProductForm');
        form.reset();
        form.product_edit_id.value = '';
        showProductFormMessage('');
      }
      function showProductFormMessage(msg, isError = false) {
        const el = document.getElementById('productFormMessage');
        el.textContent = msg;
        el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
        if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
      }
    }

    // === PATIENTS TAB ===
    // ARM wise patient N, free text box for table with formatting (contenteditable div)
    function renderPatientsTab(container, trialId) {
      const arms = getArms(trialId);
      // Count patients per arm
      const armCounts = {};
      patients.filter(p => p.trial_id === trialId).forEach(p => {
        if (!armCounts[p.arm]) armCounts[p.arm] = 0;
        armCounts[p.arm]++;
      });

      let html = `
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h3 class="text-xl font-semibold text-blue-900">Patients (ARM-wise)</h3>
          <button id="showAddPatientFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
            <i class="fas fa-plus"></i> Add Patient
          </button>
        </div>
      `;

      if (arms.length === 0) {
        html += `<p class="text-gray-600 italic mb-4">No ARMs defined yet. Add products to define ARMs.</p>`;
      } else {
        html += `<div class="mb-4 grid grid-cols-1 md:grid-cols-${arms.length} gap-4">`;
        arms.forEach(arm => {
          html += `<div class="border border-gray-300 rounded p-3 bg-gray-50">
            <h4 class="font-semibold mb-2">${arm}</h4>
            <p>Patient N: ${armCounts[arm] || 0}</p>
          </div>`;
        });
        html += `</div>`;
      }

      // Free text box for patient table (contenteditable)
      html += `
        <label class="block font-semibold mb-1">Patient Table (Editable)</label>
        <div id="patientTableEditable" contenteditable="true" class="editable-table" spellcheck="false" aria-label="Editable patient table"></div>
        <div class="mt-2 text-sm text-gray-500">You can paste or type patient data here. Use keyboard shortcuts for formatting.</div>
      `;

      // Reference inputs
      html += `
        <form id="patientReferenceForm" class="mt-6 max-w-3xl grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="patientSourceName" class="block font-medium mb-1">Reference Source Name</label>
            <input type="text" id="patientSourceName" name="source_name" placeholder="Source name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="patientReferenceLink" class="block font-medium mb-1">Reference Link</label>
            <input type="url" id="patientReferenceLink" name="reference_link" placeholder="https://example.com" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="button" id="savePatientReferenceBtn" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Save Reference
            </button>
          </div>
          <div id="patientReferenceMessage" class="md:col-span-2 text-sm mt-2"></div>
        </form>
      `;

      container.innerHTML = html;

      // Add patient form button (opens modal or alert for demo)
      document.getElementById('showAddPatientFormBtn').addEventListener('click', () => {
        alert('Add Patient form not implemented in this demo.');
      });

      // Save reference button
      document.getElementById('savePatientReferenceBtn').addEventListener('click', () => {
        const source_name = document.getElementById('patientSourceName').value.trim();
        const reference_link = document.getElementById('patientReferenceLink').value.trim();
        if (!source_name || !reference_link) {
          showPatientReferenceMessage('Source name and link are required.', true);
          return;
        }
        addReference(currentTrialId, 'patients', source_name, reference_link);
        showPatientReferenceMessage('Reference saved.');
        document.getElementById('patientSourceName').value = '';
        document.getElementById('patientReferenceLink').value = '';
      });

      function showPatientReferenceMessage(msg, isError = false) {
        const el = document.getElementById('patientReferenceMessage');
        el.textContent = msg;
        el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
        if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
      }
    }

    // === ADVERSE EVENTS TAB ===
    // ARM wise adverse event details, free text box with formatting
    function renderAdverseEventsTab(container, trialId) {
      const arms = getArms(trialId);

      let html = `
        <div class="mb-4">
          <h3 class="text-xl font-semibold text-blue-900">Adverse Events (ARM-wise)</h3>
        </div>
      `;

      if (arms.length === 0) {
        html += `<p class="text-gray-600 italic mb-4">No ARMs defined yet. Add products to define ARMs.</p>`;
      } else {
        arms.forEach(arm => {
          html += `<div class="border border-gray-300 rounded p-3 bg-gray-50 mb-4">
            <h4 class="font-semibold mb-2">${arm}</h4>
            <p>Adverse event details for ${arm} can be added below.</p>
          </div>`;
        });
      }

      // Free text box for adverse event table (contenteditable)
      html += `
        <label class="block font-semibold mb-1">Adverse Event Table (Editable)</label>
        <div id="aeTableEditable" contenteditable="true" class="editable-table" spellcheck="false" aria-label="Editable adverse event table"></div>
        <div class="mt-2 text-sm text-gray-500">You can paste or type adverse event data here. Use keyboard shortcuts for formatting.</div>
      `;

      // Reference inputs
      html += `
        <form id="aeReferenceForm" class="mt-6 max-w-3xl grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="aeSourceName" class="block font-medium mb-1">Reference Source Name</label>
            <input type="text" id="aeSourceName" name="source_name" placeholder="Source name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="aeReferenceLink" class="block font-medium mb-1">Reference Link</label>
            <input type="url" id="aeReferenceLink" name="reference_link" placeholder="https://example.com" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="button" id="saveAEReferenceBtn" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Save Reference
            </button>
          </div>
          <div id="aeReferenceMessage" class="md:col-span-2 text-sm mt-2"></div>
        </form>
      `;

      container.innerHTML = html;

      document.getElementById('saveAEReferenceBtn').addEventListener('click', () => {
        const source_name = document.getElementById('aeSourceName').value.trim();
        const reference_link = document.getElementById('aeReferenceLink').value.trim();
        if (!source_name || !reference_link) {
          showAEReferenceMessage('Source name and link are required.', true);
          return;
        }
        addReference(currentTrialId, 'adverseEvents', source_name, reference_link);
        showAEReferenceMessage('Reference saved.');
        document.getElementById('aeSourceName').value = '';
        document.getElementById('aeReferenceLink').value = '';
      });

      function showAEReferenceMessage(msg, isError = false) {
        const el = document.getElementById('aeReferenceMessage');
        el.textContent = msg;
        el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
        if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
      }
    }

    // === RESPONSE DATA TAB ===
    // patient N, arm, response type, percentage value
    function renderResponseDataTab(container, trialId) {
      const arms = getArms(trialId);

      // Count patients per arm
      const armCounts = {};
      patients.filter(p => p.trial_id === trialId).forEach(p => {
        if (!armCounts[p.arm]) armCounts[p.arm] = 0;
      });

      // Response data for trial
      const trialResponses = responseData.filter(rd => {
        const p = patients.find(pat => pat.id === rd.patient_id);
        return p && p.trial_id === trialId;
      });

      let html = `
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h3 class="text-xl font-semibold text-blue-900">Response Data</h3>
          <button id="showAddResponseFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
            <i class="fas fa-plus"></i> Add Response Data
          </button>
        </div>
      `;

      if (trialResponses.length === 0) {
        html += `<p class="text-gray-600 italic mb-4">No response data recorded yet.</p>`;
      } else {
        html += `<div class="overflow-x-auto max-h-64 scrollbar-thin border border-gray-300 rounded">
          <table class="min-w-full border-collapse border border-gray-300 text-sm">
            <thead class="bg-blue-900 text-white">
              <tr>
                <th class="px-3 py-2 text-left">Patient Code</th>
                <th class="px-3 py-2 text-left">ARM</th>
                <th class="px-3 py-2 text-left">Response Type</th>
                <th class="px-3 py-2 text-left">Percentage Value</th>
              </tr>
            </thead>
            <tbody>
              ${trialResponses.map(rd => {
                const p = patients.find(pat => pat.id === rd.patient_id);
                return `<tr class="border-t border-gray-200 hover:bg-gray-100">
                  <td class="px-3 py-1">${p ? p.patient_code : ''}</td>
                  <td class="px-3 py-1">${p ? p.arm : ''}</td>
                  <td class="px-3 py-1">${rd.response_type || ''}</td>
                  <td class="px-3 py-1">${rd.response_value || ''}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
      }

      // Add Response Data Form (hidden initially)
      html += `
        <form id="addResponseForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-3xl hidden grid grid-cols-1 md:grid-cols-2 gap-4" novalidate>
          <h4 class="md:col-span-2 text-lg font-semibold text-blue-900">Add Response Data</h4>
          <div>
            <label for="responsePatientN" class="block font-medium mb-1">Patient N *</label>
            <input type="text" id="responsePatientN" name="patient_code" placeholder="Patient code" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label for="responseArm" class="block font-medium mb-1">ARM *</label>
            <input type="text" id="responseArm" name="arm" placeholder="ARM name" list="armsList" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
            <datalist id="armsList">${getArms(currentTrialId).map(a => `<option value="${a}"></option>`).join('')}</datalist>
          </div>
          <div>
            <label for="responseType" class="block font-medium mb-1">Response Type *</label>
            <input type="text" id="responseType" name="response_type" placeholder="e.g. Partial Response" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label for="responseValue" class="block font-medium mb-1">Percentage Value *</label>
            <input type="number" id="responseValue" name="response_value" min="0" max="100" step="0.01" placeholder="%" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div class="md:col-span-2">
            <label for="responseSourceName" class="block font-medium mb-1">Reference Source Name</label>
            <input type="text" id="responseSourceName" name="source_name" placeholder="Source name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2">
            <label for="responseReferenceLink" class="block font-medium mb-1">Reference Link</label>
            <input type="url" id="responseReferenceLink" name="reference_link" placeholder="https://example.com" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="button" id="cancelResponseBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
            <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Save Response Data
            </button>
          </div>
          <div id="responseFormMessage" class="md:col-span-2 text-sm mt-2"></div>
        </form>
      `;

      container.innerHTML = html;

      document.getElementById('showAddResponseFormBtn').addEventListener('click', () => {
        resetResponseForm();
        document.getElementById('addResponseForm').classList.remove('hidden');
        document.getElementById('responsePatientN').focus();
      });

      document.getElementById('cancelResponseBtn').addEventListener('click', () => {
        resetResponseForm();
        document.getElementById('addResponseForm').classList.add('hidden');
      });

      document.getElementById('addResponseForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const patient_code = form.patient_code.value.trim();
        const arm = form.arm.value.trim();
        const response_type = form.response_type.value.trim();
        const response_value = form.response_value.value.trim();
        const source_name = form.source_name.value.trim() || null;
        const reference_link = form.reference_link.value.trim() || null;

        if (!patient_code || !arm || !response_type || !response_value) {
          showResponseFormMessage('All fields except references are required.', true);
          return;
        }

        // Find or create patient with patient_code and arm
        let patient = patients.find(p => p.patient_code.toLowerCase() === patient_code.toLowerCase() && p.trial_id === currentTrialId);
        if (!patient) {
          patient = {
            id: generateId(patients),
            trial_id: currentTrialId,
            patient_code,
            arm,
            age: null,
            gender: null,
            race: null,
            ethnicity: null
          };
          patients.push(patient);
        } else {
          patient.arm = arm; // update arm if changed
        }

        // Add arm if new
        addArm(currentTrialId, arm);

        // Add response data
        responseData.push({
          id: generateId(responseData),
          patient_id: patient.id,
          product_id: null,
          response_type,
          response_value,
          recorded_at: new Date().toISOString()
        });

        // Add reference if provided
        if (source_name && reference_link) {
          addReference(currentTrialId, 'responseData', source_name, reference_link);
        }

        showResponseFormMessage('Response data added successfully.');
        loadTabContent('responseData');
      });

      function resetResponseForm() {
        const form = document.getElementById('addResponseForm');
        form.reset();
        showResponseFormMessage('');
      }
      function showResponseFormMessage(msg, isError = false) {
        const el = document.getElementById('responseFormMessage');
        el.textContent = msg;
        el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
        if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
      }
    }

    // === SURVIVAL DATA TAB ===
    // Endpoint, hazard ratio, ARM1 patient N, ARM2 patient N, min max value
    function renderSurvivalDataTab(container, trialId) {
      const arms = getArms(trialId);

      // Survival data for trial
      const trialSurvival = survivalData.filter(sd => sd.trial_id === trialId);

      // Count patients per arm
      const armCounts = {};
      arms.forEach(a => armCounts[a] = patients.filter(p => p.trial_id === trialId && p.arm === a).length);

      let html = `
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h3 class="text-xl font-semibold text-blue-900">Survival Data</h3>
          <button id="showAddSurvivalFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
            <i class="fas fa-plus"></i> Add Survival Data
          </button>
        </div>
      `;

      if (trialSurvival.length === 0) {
        html += `<p class="text-gray-600 italic mb-4">No survival data recorded yet.</p>`;
      } else {
        html += `<div class="overflow-x-auto max-h-64 scrollbar-thin border border-gray-300 rounded text-sm">
          <table class="min-w-full border-collapse border border-gray-300">
            <thead class="bg-blue-900 text-white">
              <tr>
                <th class="px-3 py-2 text-left">Endpoint Name</th>
                <th class="px-3 py-2 text-left">Hazard Ratio</th>
                <th class="px-3 py-2 text-left">${arms[0] || 'ARM 1'} Patient N</th>
                <th class="px-3 py-2 text-left">${arms[1] || 'ARM 2'} Patient N</th>
                <th class="px-3 py-2 text-left">Min Value</th>
                <th class="px-3 py-2 text-left">Max Value</th>
              </tr>
            </thead>
            <tbody>
              ${trialSurvival.map(sd => {
                return `<tr class="border-t border-gray-200 hover:bg-gray-100">
                  <td class="px-3 py-1">${sd.endpoint_type || ''}</td>
                  <td class="px-3 py-1">${sd.hazard_ratio || ''}</td>
                  <td class="px-3 py-1">${sd.arm1_patient_n !== undefined && sd.arm1_patient_n !== null ? sd.arm1_patient_n : armCounts[arms[0]] || 0}</td>
                  <td class="px-3 py-1">${sd.arm2_patient_n !== undefined && sd.arm2_patient_n !== null ? sd.arm2_patient_n : armCounts[arms[1]] || 0}</td>
                  <td class="px-3 py-1">${sd.min_value || ''}</td>
                  <td class="px-3 py-1">${sd.max_value || ''}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
      }

      // Add Survival Data Form (hidden initially)
      html += `
        <form id="addSurvivalForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-4xl hidden grid grid-cols-1 md:grid-cols-3 gap-4" novalidate>
          <h4 class="md:col-span-3 text-lg font-semibold text-blue-900">Add Survival Data</h4>
          <div>
            <label for="survivalEndpointName" class="block font-medium mb-1">Endpoint Name *</label>
            <input type="text" id="survivalEndpointName" name="endpoint_type" placeholder="e.g. OS, PFS" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label for="survivalHazardRatio" class="block font-medium mb-1">Hazard Ratio *</label>
            <input type="number" id="survivalHazardRatio" name="hazard_ratio" step="0.01" min="0" placeholder="Hazard ratio" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label class="block font-medium mb-1">Patient N per ARM</label>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label for="arm1PatientN" class="block text-sm font-normal mb-1">${arms[0] || 'ARM 1'}</label>
                <input type="number" id="arm1PatientN" name="arm1_patient_n" min="0" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
              </div>
              <div>
                <label for="arm2PatientN" class="block text-sm font-normal mb-1">${arms[1] || 'ARM 2'}</label>
                <input type="number" id="arm2PatientN" name="arm2_patient_n" min="0" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
              </div>
            </div>
          </div>
          <div>
            <label for="survivalMinValue" class="block font-medium mb-1">Min Value</label>
            <input type="number" id="survivalMinValue" name="min_value" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="survivalMaxValue" class="block font-medium mb-1">Max Value</label>
            <input type="number" id="survivalMaxValue" name="max_value" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-3">
            <label for="survivalSourceName" class="block font-medium mb-1">Reference Source Name</label>
            <input type="text" id="survivalSourceName" name="source_name" placeholder="Source name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-3">
            <label for="survivalReferenceLink" class="block font-medium mb-1">Reference Link</label>
            <input type="url" id="survivalReferenceLink" name="reference_link" placeholder="https://example.com" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-3 flex justify-end gap-4">
            <button type="button" id="cancelSurvivalBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
            <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Save Survival Data
            </button>
          </div>
          <div id="survivalFormMessage" class="md:col-span-3 text-sm mt-2"></div>
        </form>
      `;

      container.innerHTML = html;

      document.getElementById('showAddSurvivalFormBtn').addEventListener('click', () => {
        resetSurvivalForm();
        document.getElementById('addSurvivalForm').classList.remove('hidden');
        document.getElementById('survivalEndpointName').focus();
      });

      document.getElementById('cancelSurvivalBtn').addEventListener('click', () => {
        resetSurvivalForm();
        document.getElementById('addSurvivalForm').classList.add('hidden');
      });

      document.getElementById('addSurvivalForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const endpoint_type = form.endpoint_type.value.trim();
        const hazard_ratio = form.hazard_ratio.value.trim();
        const arm1_patient_n = form.arm1_patient_n.value.trim();
        const arm2_patient_n = form.arm2_patient_n.value.trim();
        const min_value = form.min_value.value.trim();
        const max_value = form.max_value.value.trim();
        const source_name = form.source_name.value.trim() || null;
        const reference_link = form.reference_link.value.trim() || null;

        if (!endpoint_type || !hazard_ratio) {
          showSurvivalFormMessage('Endpoint Name and Hazard Ratio are required.', true);
          return;
        }

        // Save survival data as one record per trial (simplified)
        survivalData.push({
          id: generateId(survivalData),
          patient_id: null,
          trial_id: currentTrialId,
          endpoint_type,
          hazard_ratio,
          arm1_patient_n: arm1_patient_n ? parseInt(arm1_patient_n) : null,
          arm2_patient_n: arm2_patient_n ? parseInt(arm2_patient_n) : null,
          min_value: min_value ? parseFloat(min_value) : null,
          max_value: max_value ? parseFloat(max_value) : null
        });

        if (source_name && reference_link) {
          addReference(currentTrialId, 'survivalData', source_name, reference_link);
        }

        showSurvivalFormMessage('Survival data added successfully.');
        loadTabContent('survivalData');
      });

      function resetSurvivalForm() {
        const form = document.getElementById('addSurvivalForm');
        form.reset();
        showSurvivalFormMessage('');
      }
      function showSurvivalFormMessage(msg, isError = false) {
        const el = document.getElementById('survivalFormMessage');
        el.textContent = msg;
        el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
        if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
      }
    }

    // === REGULATORY ANNOUNCEMENTS TAB ===
    // Reference link, reference name, date published, description box
    function renderRegulatoryEventsTab(container, trialId) {
      const trialRegs = regulatoryEvents.filter(re => re.trial_id === trialId);

      let html = `
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h3 class="text-xl font-semibold text-blue-900">Regulatory Announcements</h3>
          <button id="showAddRegulatoryFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
            <i class="fas fa-plus"></i> Add Announcement
          </button>
        </div>
      `;

      if (trialRegs.length === 0) {
        html += `<p class="text-gray-600 italic mb-4">No regulatory announcements recorded yet.</p>`;
      } else {
        html += `<div class="overflow-x-auto max-h-64 scrollbar-thin border border-gray-300 rounded text-sm">
          <table class="min-w-full border-collapse border border-gray-300">
            <thead class="bg-blue-900 text-white">
              <tr>
                <th class="px-3 py-2 text-left">Reference Name</th>
                <th class="px-3 py-2 text-left">Reference Link</th>
                <th class="px-3 py-2 text-left">Date Published</th>
                <th class="px-3 py-2 text-left">Description</th>
              </tr>
            </thead>
            <tbody>
              ${trialRegs.map(re => `
                <tr class="border-t border-gray-200 hover:bg-gray-100">
                  <td class="px-3 py-1">${re.reference_name || ''}</td>
                  <td class="px-3 py-1"><a href="${re.reference_link}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline break-all">${re.reference_link}</a></td>
                  <td class="px-3 py-1">${re.date_published || ''}</td>
                  <td class="px-3 py-1">${re.description || ''}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
      }

      // Add Regulatory Announcement Form (hidden initially)
      html += `
        <form id="addRegulatoryForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-4xl hidden grid grid-cols-1 md:grid-cols-2 gap-4" novalidate>
          <h4 class="md:col-span-2 text-lg font-semibold text-blue-900">Add Regulatory Announcement</h4>
          <div>
            <label for="regulatoryReferenceName" class="block font-medium mb-1">Reference Name *</label>
            <input type="text" id="regulatoryReferenceName" name="reference_name" placeholder="Reference name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label for="regulatoryReferenceLink" class="block font-medium mb-1">Reference Link *</label>
            <input type="url" id="regulatoryReferenceLink" name="reference_link" placeholder="https://example.com" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" required />
          </div>
          <div>
            <label for="regulatoryDatePublished" class="block font-medium mb-1">Date Published</label>
            <input type="date" id="regulatoryDatePublished" name="date_published" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2">
            <label for="regulatoryDescription" class="block font-medium mb-1">Description</label>
            <textarea id="regulatoryDescription" name="description" rows="3" placeholder="Description" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600 resize-y"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="button" id="cancelRegulatoryBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
            <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Save Announcement
            </button>
          </div>
          <div id="regulatoryFormMessage" class="md:col-span-2 text-sm mt-2"></div>
        </form>
      `;

      container.innerHTML = html;

      document.getElementById('showAddRegulatoryFormBtn').addEventListener('click', () => {
        resetRegulatoryForm();
        document.getElementById('addRegulatoryForm').classList.remove('hidden');
        document.getElementById('regulatoryReferenceName').focus();
      });

      document.getElementById('cancelRegulatoryBtn').addEventListener('click', () => {
        resetRegulatoryForm();
        document.getElementById('addRegulatoryForm').classList.add('hidden');
      });

      document.getElementById('addRegulatoryForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const reference_name = form.reference_name.value.trim();
        const reference_link = form.reference_link.value.trim();
        const date_published = form.date_published.value || null;
        const description = form.description.value.trim() || null;

        if (!reference_name || !reference_link) {
          showRegulatoryFormMessage('Reference name and link are required.', true);
          return;
        }

        regulatoryEvents.push({
          id: generateId(regulatoryEvents),
          trial_id: currentTrialId,
          reference_name,
          reference_link,
          date_published,
          description
        });

        addReference(currentTrialId, 'regulatoryEvents', reference_name, reference_link);

        showRegulatoryFormMessage('Regulatory announcement added successfully.');
        loadTabContent('regulatoryEvents');
      });

      function resetRegulatoryForm() {
        const form = document.getElementById('addRegulatoryForm');
        form.reset();
        showRegulatoryFormMessage('');
      }
      function showRegulatoryFormMessage(msg, isError = false) {
        const el = document.getElementById('regulatoryFormMessage');
        el.textContent = msg;
        el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
        if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
      }
    }

    // === REFERENCES TAB ===
    // Show all references from all tabs with hyperlinks
    function renderReferencesTab(container, trialId) {
      const trialRefs = references.filter(r => r.trial_id === trialId);

      let html = `
        <h3 class="text-xl font-semibold text-blue-900 mb-4">All References</h3>
      `;

      if (trialRefs.length === 0) {
        html += `<p class="text-gray-600 italic">No references added yet.</p>`;
      } else {
        html += `<ul class="list-disc list-inside space-y-2 text-sm">`;
        trialRefs.forEach(r => {
          html += `<li>
            <strong>[${r.tab}]</strong> 
            <a href="${r.link}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline">${r.source_name}</a>
          </li>`;
        });
        html += `</ul>`;
      }

      container.innerHTML = html;
    }

    // Initialize product tags select on page load
    window.addEventListener('load', () => {
      populateProductTags();
    });
  </script>
</body>
</html>